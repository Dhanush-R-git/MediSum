{% extends "base.html" %}
{% block title %}Dashboard – {{ selected if selected else '' }}{% endblock %}

{% block main_content %}
  {% if not selected %}
    <!-- No patient selected: show placeholder text -->
    <div class="h-full flex items-center justify-center text-gray-400">
      <p>Select a patient from the right panel or create a new one.</p>
    </div>
  {% else %}
    <!-- TABS HEADER -->
    <div class="flex space-x-6 border‐b border‐gray-200 pb-3 mb-4 bg-transparent sticky top-0 z-10">
      <button class="tab-btn text-gray-700 px-3 py-1 border-b-2 border-indigo-500 font-medium bg-gray-100 rounded-md hover:bg-gray-200" data-tab="overview">Overview</button>
      <button class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200" data-tab="caremgmt">Care Management</button>
      <button class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200" data-tab="documents">Documents</button>
      <button class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200" data-tab="scheduling">Scheduling</button>
      <button class="tab-btn text-gray-500 hover:text-gray-700 px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200" data-tab="encounters">Encounters</button>
      <div class="ml-auto">
        <button id="customize_charts_btn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Customize Charts</button>
      </div>
    </div>

    <!-- TAB PANELS -->
    <div id="overview" class="tab-panel">
      <!-- Patient Timeline & Description Section -->
      <div class="grid grid-cols-2 gap-6">
        <!-- Left: Timeline -->
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-semibold text-gray-700">Patient Timeline</h3>
            <select id="timeline_year" class="bg-white border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200">
              {% set years = [2024] %}
              {% set selected_year = 2024 %}
              {% for y in years %}
                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="space-y-4">
            {% for event in timeline %}
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <div class="h-2 w-2 mt-1 rounded-full bg-indigo-500"></div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-semibold">{{ event.title }} <span class="text-gray-400">• {{ event.date }}</span></p>
                <p class="text-sm text-gray-600">{{ event.desc }}</p>
              </div>
            </div>
            {% endfor %}
            <div class="text-indigo-500 text-sm hover:underline cursor-pointer">Full History</div>
          </div>
        </div>

        <!-- Right: Patient Description -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Patient Description</h3>
          <p class="text-sm text-gray-600">
            Patients identified with specific conditions falling under HCC may require more intensive
            care or resources, influencing payment structures within the healthcare system.
          </p>
        </div>
      </div>

      <!-- Goals & Activities + Actions -->
      <div class="grid grid-cols-2 gap-6 mt-6">
        <!-- Goals & Activities -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Goals & Activities</h3>
          <div class="space-y-3">
            {% for goal in goals_activities %}
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>{{ goal.label }}</span>
                <span>{{ goal.percent }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-indigo-500 h-2 rounded-full" style="width: {{ goal.percent }}%;"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Actions</h3>
          <div class="space-y-2">
            {% for act in actions_list %}
            <label class="flex items-center space-x-2">
              <input type="checkbox" class="h-4 w-4 text-indigo-500 border-gray-300 rounded" {% if act.checked %}checked{% endif %}>
              <span class="text-sm text-gray-700">{{ act.label }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Quality Measures & Documentation -->
      <div class="bg-white rounded-lg shadow p-4 mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-3">Quality Measures & Documentation</h3>
        <div class="space-y-3">
          {% for qm in quality_measures %}
          <div class="flex justify-between items-center">
            <div class="text-sm text-gray-700">{{ qm.label }}</div>
            {% if qm.status == 'Pending' %}
              <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Pending</span>
            {% elif qm.status == 'Completed' %}
              <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Completed</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Generate Summary & Expert Email (optional) -->
      <div class="flex justify-end mt-6 space-x-4">
        <button id="generate_summary_btn" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">
          Generate Summary
        </button>
        <button id="send_expert_btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
          Send to Expert
        </button>
      </div>

      <!-- Daily Progress Notes Section for Dashboard Overview Tab -->
      <div id="daily_progress_notes" class="bg-white rounded-xl shadow-md p-6 mt-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-indigo-700 flex items-center gap-2">
            <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 17l4 4 4-4m0-5V3m-8 4h8"/>
            </svg>
            Recent Daily Progress Notes
          </h3>
          <!-- Optional: Add button for new note -->
          <a href="{{ url_for('coord_upload_progress_report') }}"
             class="inline-block px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-medium hover:bg-indigo-100 transition">
            + Add Note
          </a>
        </div>
        {% if daily_history %}
          <ul class="divide-y divide-indigo-50">
            {% for d in daily_history %}
            <li class="py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>
                <span class="font-medium text-gray-800">{{ d.datetime }}</span>
                <span class="mx-2 text-gray-400">|</span>
                <span class="text-gray-600">{{ d.provider }}</span>
              </div>
              <div class="flex items-center gap-3">
                <a href="{{ url_for('download_file', filename=d.file) }}"
                   class="text-indigo-600 hover:underline text-sm font-medium flex items-center gap-1">
                  <svg class="h-4 w-4 inline" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"/>
                  </svg>
                  Download
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-gray-500 italic text-sm">No daily progress notes yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- Placeholder panels for other tabs (hidden by default) -->
    <div id="caremgmt" class="tab-panel hidden">
      <div class="text-gray-500 italic">Care Management content goes here.</div>
    </div>
    <!-- Documents Tab -->
    <div id="documents" class="tab-panel hidden space-y-6">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Progress Report History</h3>
        {% if progress_history %}
          <ul class="space-y-2">
            {% for log in progress_history %}
            <li class="flex items-center justify-between">
              <span class="text-sm text-gray-800">
                {{ log.timestamp }} by {{ log.uploaded_by }}
              </span>
              <a href="{{ url_for('download_file', filename=log.file_path) }}"
                class="text-indigo-600 hover:underline text-sm">
                Download
              </a>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-gray-500 text-sm italic">No progress reports uploaded yet.</p>
        {% endif %}
      </div>
    </div>
    <div id="scheduling" class="tab-panel hidden">
      <div class="text-gray-500 italic">Scheduling content goes here.</div>
    </div>
    <div id="encounters" class="tab-panel hidden">
      <div class="text-gray-500 italic">Encounters content goes here.</div>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  // TAB SWITCHING LOGIC
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanels = document.querySelectorAll('.tab-panel');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Clear all active classes
      tabButtons.forEach(b => {
        b.classList.remove('border-indigo-500', 'text-gray-700');
        b.classList.add('text-gray-500');
      });
      tabPanels.forEach(p => p.classList.add('hidden'));

      // Activate clicked
      btn.classList.remove('text-gray-500');
      btn.classList.add('text-gray-700', 'border-indigo-500');
      const target = btn.getAttribute('data-tab');
      document.getElementById(target).classList.remove('hidden');
    });
  });

  // Make “Overview” active by default
  if (tabButtons.length > 0) {
    tabButtons[0].click();
  }

  // GENERATE SUMMARY BUTTON HANDLER (AJAX)
  const genBtn = document.getElementById('generate_summary_btn');
  if (genBtn) {
    genBtn.addEventListener('click', async () => {
      const pid = "{{ selected }}";
      if (!pid) return;

      genBtn.setAttribute('disabled', 'true');
      genBtn.innerText = 'Generating...';

      try {
        const resp = await fetch("{{ url_for('generate_summary') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ patientId: pid })
        });
        const data = await resp.json();
        if (resp.ok) {
          alert("Summary generated. Scroll down to see text or download PDF from Summaries page.");
        } else {
          alert("Error: " + data.error);
        }
      } catch (err) {
        alert("Error generating summary.");
      } finally {
        genBtn.removeAttribute('disabled');
        genBtn.innerText = 'Generate Summary';
      }
    });
  }

  // SEND TO EXPERT MODAL
  const sendBtn = document.getElementById('send_expert_btn');
  if (sendBtn) {
    sendBtn.addEventListener('click', () => {
      // Show a prompt to pick expert email (you could build a dropdown or prompt())
      const expertEmail = prompt("Enter expert's email address:");
      const summaryText = prompt("Paste summary text here, or leave blank to fetch latest:");
      if (!expertEmail || !summaryText) return;

      fetch("{{ url_for('send_expert_email') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientId: "{{ selected }}", expertEmail, summaryText })
      })
      .then(r => r.json())
      .then(data => {
        if (data.message) {
          alert("Email sent successfully.");
        } else {
          alert("Error: " + (data.error || data.message));
        }
      })
      .catch(() => alert("Error sending email."));
    });
  }

  // PATIENT LIST SEARCH & CLICK HANDLER
  const patientSearch = document.getElementById('patient_search');
  const patientListContainer = document.getElementById('patient_list');

  if (patientSearch && patientListContainer) {
    patientSearch.addEventListener('input', () => {
      const term = patientSearch.value.toLowerCase();
      const rows = patientListContainer.querySelectorAll('.patient-row');
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        if (text.includes(term)) {
          row.classList.remove('hidden');
        } else {
          row.classList.add('hidden');
        }
      });
    });

    patientListContainer.querySelectorAll('.patient-row').forEach(row => {
      row.addEventListener('click', () => {
        const pid = row.getAttribute('data-pid');
        window.location.href = "{{ url_for('dashboard', patient_id='') }}" + pid;
      });
    });
  }

</script>
{% endblock %}
